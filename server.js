const { Telegraf } = require('telegraf');
const express = require('express');
const admin = require('firebase-admin');

// ----------------------------------------------------------------------
// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase Admin SDK (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î —Å –±—ç–∫–µ–Ω–¥–∞)
// ----------------------------------------------------------------------

// –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Koyeb!
if (!admin.apps.length) {
    // –í–ê–ñ–ù–û: –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ Koyeb –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π, 
    // –ø–æ—ç—Ç–æ–º—É –º—ã –∑–∞–º–µ–Ω—è–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ.
    const privateKey = process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n');
    
    admin.initializeApp({
        credential: admin.credential.cert({
            projectId: process.env.FIREBASE_PROJECT_ID,
            privateKey: privateKey, 
            clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
        }),
    });
}
const db = admin.firestore();

// ----------------------------------------------------------------------
// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express –∏ Telegram Bot
// ----------------------------------------------------------------------

const botToken = process.env.BOT_TOKEN;
const miniAppUrl = process.env.MINI_APP_URL; // URL –≤–∞—à–µ–≥–æ Netlify
const bot = new Telegraf(botToken);
const app = express();
// Koyeb –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PORT
const port = process.env.PORT || 3000; 

// ----------------------------------------------------------------------
// 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Webhook (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram)
// ----------------------------------------------------------------------

// Koyeb –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL. –ù–∞–º –Ω—É–∂–µ–Ω –±–æ—Ç-—Ç–æ–∫–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—É—Ç–∏.
const webhookPath = '/telegraf/' + botToken; 

// ******************************************************************************
// –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è Koyeb –ª—É—á—à–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Webhook –û–î–ò–ù –†–ê–ó –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ BotFather
// (—Å–º. –®–∞–≥ 5 –≤ —Ç—É—Ç–æ—Ä–∏–∞–ª–µ), —Ç–∞–∫ –∫–∞–∫ Koyeb –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç URL —á–µ—Ä–µ–∑ ENV.
// –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –±–æ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª Webhook —Å–∞–º, –≤–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π URL Koyeb.
// –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ Express/WebhookCallback –∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—Ç—å,
// —á—Ç–æ –≤–Ω–µ—à–Ω–∏–π Webhook —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.
// ******************************************************************************

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Express –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è Webhook –Ω–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º –ø—É—Ç–∏
app.use(bot.webhookCallback(webhookPath)); 

// ----------------------------------------------------------------------
// 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
// ----------------------------------------------------------------------

// –ö–æ–º–∞–Ω–¥–∞ /start - –∑–∞–ø—É—Å–∫–∞–µ—Ç Mini App
bot.start((ctx) => {
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—à–µ Mini App (URL –±–µ—Ä–µ—Ç—Å—è –∏–∑ Koyeb ENV)
    const inlineKeyboard = {
        reply_markup: {
            inline_keyboard: [
                [{ 
                    text: '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ú–µ—Å—Ç–æ', 
                    web_app: { url: miniAppUrl } 
                }]
            ]
        }
    };

    ctx.reply(
        `–ü—Ä–∏–≤–µ—Ç, ${ctx.message.from.first_name}! ü§ñ\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–≤–æ—Ä–∫–∏–Ω–≥–∞.`,
        inlineKeyboard
    );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–∑ Mini App —á–µ—Ä–µ–∑ sendData()
bot.on('web_app_data', async (ctx) => {
    try {
        const data = JSON.parse(ctx.message.web_app_data.data);
        
        if (data.action === 'booked') {
            const deskId = data.deskId;
            const date = data.date;
            
            // –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            
            ctx.reply(`ü•≥ –û—Ç–ª–∏—á–Ω–æ! –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–µ—Å—Ç–∞ **${deskId}** –Ω–∞ **${date}** –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!`, { parse_mode: 'Markdown' });
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ Web App Data:", e);
        ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.");
    }
});

// ----------------------------------------------------------------------
// 5. API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–ª—è –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
// ----------------------------------------------------------------------

app.get('/', (req, res) => {
    res.send('Telegram Bot –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç Koyeb. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram.');
});

// –ü—Ä–∏–º–µ—Ä: API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç —Å –±—ç–∫–µ–Ω–¥–∞ (–∏–∑ Firebase)
app.get('/api/workspaces', async (req, res) => {
    try {
        const snapshot = await db.collection('workspaces').get();
        const workspaces = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        res.json(workspaces);
    } catch (error) {
        console.error("Error fetching workspaces:", error);
        res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç–∞—Ö." });
    }
});

// ----------------------------------------------------------------------
// 6. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
// ----------------------------------------------------------------------

app.listen(port, () => {
    console.log(`–°–µ—Ä–≤–µ—Ä Express/Telegraf –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${port}`);
});
